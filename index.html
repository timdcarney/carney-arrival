<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Carney Arrival Predictor</title>
<meta name="theme-color" content="#f6f3ff">
<style>
  :root{
    --bg:#f8fafc; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
    --accent:#a78bfa; --accent-2:#f0abfc; --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --radius:18px;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background:var(--bg); color:var(--ink);}
  .wrap{max-width:720px; margin:0 auto; padding:16px 16px 96px}
  header{display:flex; align-items:center; gap:12px; padding:12px 0}
  .logo{font-size:28px}
  .title{font-weight:800; font-size:20px; line-height:1.1}
  .card{background:var(--card); border-radius:var(--radius); box-shadow:0 8px 24px rgba(2,6,23,.06); padding:14px}
  .grid{display:grid; gap:12px}
  .two{grid-template-columns:repeat(2,1fr)}
  @media (min-width:640px){ .two{grid-template-columns:repeat(2,1fr)} }
  label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
  input, select, button{width:100%; padding:12px 14px; border:1px solid #e5e7eb; border-radius:12px; font-size:16px; background:white}
  input:focus, select:focus, button:focus{outline:3px solid #e9d5ff; border-color:#d8b4fe}
  button{cursor:pointer; border:none; background:linear-gradient(180deg, var(--accent), var(--accent-2)); color:white; font-weight:700}
  button.secondary{background:#f1f5f9; color:#0f172a; border:1px solid #e5e7eb}
  .muted{color:var(--muted)}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .status{padding:10px 12px; border-radius:12px; background:#f1f5f9}
  .status.open{background:#ecfeff}
  .status.closed{background:#fff7ed}
  .status.winner{background:#ecffec}
  table{width:100%; border-collapse:separate; border-spacing:0 8px}
  th{font-size:12px; color:var(--muted); text-align:left; padding:0 8px}
  td{background:var(--card); padding:12px 8px; border-top:1px solid #eef2f7; border-bottom:1px solid #eef2f7}
  tr td:first-child{border-left:1px solid #eef2f7; border-radius:12px 0 0 12px}
  tr td:last-child{border-right:1px solid #eef2f7; border-radius:0 12px 12px 0}
  .badge{display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:999px; background:#f1f5f9; font-size:12px}
  footer{position:fixed; inset:auto 0 0 0; background:rgba(255,255,255,.9); backdrop-filter:saturate(1.2) blur(6px); padding:10px 14px; border-top:1px solid #e5e7eb; display:flex; justify-content:center}
  .tiny{font-size:12px}
  .countdown{font-variant-numeric:tabular-nums; font-weight:800}
  .pill{border-radius:999px; padding:4px 10px; font-size:12px; background:#eef2ff; color:#3730a3}
  .admin-toggle{background:#fee2e2; color:#991b1b; border:1px solid #fecaca}
  .winner{background:#f0fdf4 !important}
  .medal{font-size:18px}
  .hidden{display:none !important}
  .diag{font-size:12px; line-height:1.3; background:#fff7ed; border:1px dashed #f59e0b; color:#7c2d12; padding:8px 10px; border-radius:12px}
  .diag code{font-size:12px}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">üë∂‚è∞üíû</div>
      <div>
        <div class="title">Carney Arrival Predictor</div>
        <div class="muted tiny">Made with love while waiting for Baby Carney üíï</div>
      </div>
      <div style="margin-left:auto"><button id="shareBtn" class="secondary">Share</button></div>
    </header>

    <div id="statusBanner" class="status card">Loading‚Ä¶</div>

    <!-- Countdown -->
    <div class="card row" id="countdownBlock">
      <div class="badge">‚è≥ Submissions close in <span id="countdown" class="countdown">--:--:--</span></div>
      <span id="windowRange" class="muted tiny"></span>
      <span class="pill" id="sortHint">Sorting: latest submissions</span>
    </div>

    <!-- Submission Form -->
    <form id="predictForm" class="card grid" aria-label="Submit a prediction">
      <div class="grid two">
        <div>
          <label for="name">Your Name</label>
          <input id="name" name="name" required placeholder="Pat, Granny, etc." autocomplete="name" />
        </div>
        <div>
          <label for="phone">Phone (for dedupe & optional updates)</label>
          <input id="phone" name="phone" required inputmode="tel" placeholder="(###) ###-####" />
        </div>
      </div>
      <div class="grid two">
        <div>
          <label for="predDate">Predicted Date</label>
          <input id="predDate" type="date" required />
        </div>
        <div>
          <label for="predTime">Predicted Time</label>
          <input id="predTime" type="time" required />
        </div>
      </div>
      <div class="grid two">
        <div>
          <label for="confidence">Confidence (1‚Äì5)</label>
          <select id="confidence" required>
            <option value="5">5 ‚Äì Very confident</option>
            <option value="4">4</option>
            <option value="3" selected>3 ‚Äì Middle</option>
            <option value="2">2</option>
            <option value="1">1 ‚Äì Just for fun</option>
          </select>
        </div>
        <div>
          <label>&nbsp;</label>
          <button id="submitBtn">Submit Prediction</button>
        </div>
      </div>
      <div class="tiny muted">We‚Äôll only show the last 4 digits of your phone on the board. One guess per phone during the window.</div>
    </form>

    <!-- Leaderboard -->
    <div class="card grid" id="boardCard">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <strong>Leaderboard</strong>
          <span id="entriesCount" class="pill">0 entries</span>
        </div>
        <div class="row">
          <button id="sortModeBtn" class="secondary tiny" style="padding:8px 10px">Toggle Sort</button>
        </div>
      </div>
      <div class="grid">
        <table aria-label="Predictions leaderboard">
          <thead>
            <tr>
              <th>Name</th>
              <th>Predicted</th>
              <th>Conf.</th>
              <th>Submitted</th>
              <th>Œî (if set)</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Admin -->
    <div class="card grid" id="adminCard">
      <div class="row" style="justify-content:space-between">
        <strong>Admin</strong>
        <button id="adminToggle" class="admin-toggle tiny" style="padding:8px 10px">Admin Mode</button>
      </div>
      <div id="adminPanel" class="grid hidden">
        <div class="grid two">
          <div>
            <label>Passphrase</label>
            <input id="adminPass" type="password" placeholder="passphrase" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="unlockBtn" class="secondary">Unlock</button>
          </div>
        </div>
        <div class="grid two">
          <div>
            <label>Window Start (local)</label>
            <input id="windowStart" type="datetime-local" />
          </div>
          <div>
            <label>Window End (auto 72h)</label>
            <input id="windowEnd" type="datetime-local" disabled />
          </div>
        </div>
        <div class="row">
          <button id="saveWindowBtn">Save Window</button>
          <button id="toggleSubBtn" class="secondary">Toggle Submissions</button>
        </div>
        <div class="grid two">
          <div>
            <label>Actual Arrival (local)</label>
            <input id="actualArrival" type="datetime-local" />
          </div>
          <div>
            <label>&nbsp;</label>
            <button id="setActualBtn">Set Actual & Rank</button>
          </div>
        </div>
        <div class="row">
          <button id="exportBtn" class="secondary">Export CSV</button>
          <span id="winnerBadge" class="badge hidden">Winner: <span id="winnerText"></span></span>
        </div>
      </div>
    </div>

    <!-- Diagnostics (auto-filled if something goes wrong) -->
    <div id="diag" class="diag card hidden"></div>
  </div>

  <footer>
    <div class="tiny">Made with love while waiting for Baby Carney üíï</div>
  </footer>

<script>
/** =========================
 *  CONFIG (edit these)
 *  ========================= */
const CONFIG = {
  API_URL: 'https://script.google.com/macros/s/AKfycbwxvAp7E9IgTOjP-ry5CNowhPVqLab76qjqiTlxCWZyY1S5FIhkB0dAEvGtipEZv262/exec',
  ADMIN_PASSPHRASE_HINT: 'Ask Tim üí™',
  APP_NAME: 'Carney Arrival Predictor',
};

/** =========================
 *  UTILITIES
 *  ========================= */
const $ = s => document.querySelector(s);
const fmt = {
  maskPhone: p => { const d=(p||'').replace(/\D/g,''); return d.length<4? '(‚Ä¢‚Ä¢‚Ä¢) ‚Ä¢‚Ä¢‚Ä¢-'+d : '(‚Ä¢‚Ä¢‚Ä¢) ‚Ä¢‚Ä¢‚Ä¢-'+d.slice(-4); },
  iso: d => new Date(d).toISOString(),
  localDateTimeInputValue: iso => { if(!iso) return ''; const d=new Date(iso),pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`; },
  toLocal: iso => new Date(iso).toLocaleString([], {hour:'2-digit',minute:'2-digit',month:'short',day:'numeric'}),
  deltaLabel: (a,b)=>{ const ms=Math.abs(new Date(a)-new Date(b)); const m=Math.floor(ms/60000),h=Math.floor(m/60),mm=m%60; return (h?`${h}h `:'')+`${mm}m`; },
  nowIso: () => new Date().toISOString(),
  confetti: ()=>{
    const e=document.createElement('div'); e.style.position='fixed'; e.style.inset='0'; e.style.pointerEvents='none';
    for(let i=0;i<24;i++){ const s=document.createElement('div'); s.textContent=['üéâ','üéä','üçº','üíñ','‚ú®'][Math.floor(Math.random()*5)];
      s.style.position='absolute'; s.style.left=Math.random()*100+'%'; s.style.top='-10px'; s.style.fontSize=(16+Math.random()*14)+'px';
      s.style.animation=`fall ${2+Math.random()*2}s linear ${Math.random()}s forwards`; e.appendChild(s);}
    const st=document.createElement('style'); st.textContent=`@keyframes fall{to{transform:translateY(110vh) rotate(1turn);opacity:.2}}`;
    document.body.appendChild(st); document.body.appendChild(e); setTimeout(()=>e.remove(),5000);
  }
};

/** =========================
 *  CORS-safe storage client + healthcheck
 *  ========================= */
const storage = {
  // Use text/plain to avoid OPTIONS preflight (prevents ‚ÄúFailed to fetch‚Äù from Pages)
  async api(action, payload={}) {
    const res = await fetch(CONFIG.API_URL, {
      method:'POST',
      headers:{'Content-Type':'text/plain;charset=utf-8'},
      body: JSON.stringify({action, payload})
    });
    if(!res.ok) throw new Error(`API error ${res.status}`);
    const data = await res.json();
    if(data.error) throw new Error(data.error);
    return data;
  },
  listPredictions(){ return this.api('listPredictions'); },
  getSettings(){ return this.api('getSettings'); },
  savePrediction(p){ return this.api('savePrediction', p); },
  setWindow(startIso, adminPass){ return this.api('setWindow', {startIso, adminPass}); },
  toggleSubmissions(adminPass){ return this.api('toggleSubmissions', {adminPass}); },
  setActualArrival(iso, adminPass){ return this.api('setActualArrival', {iso, adminPass}); },
  exportCSV(adminPass){ return this.api('exportCSV', {adminPass}); },

  // GET healthcheck (no preflight). Useful for surfacing clear errors in UI.
  async health() {
    try {
      const r = await fetch(CONFIG.API_URL); // simple GET
      if(!r.ok) return {ok:false, msg:`GET ${r.status}`};
      const j = await r.json();
      return {ok:true, json:j};
    } catch (e) {
      return {ok:false, msg:String(e)};
    }
  }
};

/** =========================
 *  STATE & RENDER
 *  ========================= */
const state = { settings:null, predictions:[], sortMode:'submittedAt', adminUnlocked:false, winner:null };

function showDiag(msg) {
  const d = $('#diag'); d.classList.remove('hidden');
  d.innerHTML = `<strong>Diagnostics</strong><br>${msg}`;
}

function renderStatus(){
  const s = state.settings, el = $('#statusBanner');
  if(!s){ el.textContent='Loading‚Ä¶'; return; }
  const now=new Date(), start=new Date(s.windowStart), end=new Date(s.windowEnd), within = now>=start && now<=end;
  if(s.actualArrivalAt){ el.className="status card winner"; el.textContent = `We have a winner! üéâ Baby arrived ${fmt.toLocal(s.actualArrivalAt)}.`; }
  else if(s.submissionsOpen && within){ el.className="status card open"; el.textContent = `Still baking üë∂ ‚Äî Predictions are OPEN.`; }
  else{ el.className="status card closed"; el.textContent = `Labor in progress üöÄ (predictions closed)`; }
}

function renderCountdown(){
  const s=state.settings, block=$('#countdownBlock'); if(!s){ block.classList.add('hidden'); return; }
  $('#windowRange').textContent = `${fmt.toLocal(s.windowStart)} ‚Üí ${fmt.toLocal(s.windowEnd)}`;
  const tick=()=>{ const n=Date.now(), end=new Date(s.windowEnd).getTime(), ms=end-n, cd=$('#countdown');
    if(ms<=0){ cd.textContent='00:00:00'; return; }
    const sec=Math.floor(ms/1000)%60, min=Math.floor(ms/60000)%60, hr=Math.floor(ms/3600000);
    cd.textContent = `${String(hr).padStart(2,'0')}:${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
    requestAnimationFrame(tick); }; requestAnimationFrame(tick);
}

function rankAndSort(){
  const s=state.settings, arr=[...state.predictions];
  if(s.actualArrivalAt){
    arr.sort((a,b)=>{
      const da=Math.abs(new Date(a.predictedAt)-new Date(s.actualArrivalAt));
      const db=Math.abs(new Date(b.predictedAt)-new Date(s.actualArrivalAt));
      if(da!==db) return da-db; if(b.confidence!==a.confidence) return b.confidence-a.confidence;
      return new Date(a.submittedAt)-new Date(b.submittedAt);
    });
    state.winner = arr[0] || null; return arr;
  }
  if(state.sortMode==='predictedAt'){ arr.sort((a,b)=> new Date(a.predictedAt)-new Date(b.predictedAt)); return arr; }
  arr.sort((a,b)=> new Date(b.submittedAt)-new Date(a.submittedAt)); return arr;
}

function renderBoard(){
  const s=state.settings, tbody=$('#tbody'); tbody.innerHTML=''; const rows=rankAndSort();
  $('#entriesCount').textContent = `${rows.length} entries`; const medals=['ü•á','ü•à','ü•â'];
  rows.forEach((p,idx)=>{ const tr=document.createElement('tr'), isWinner=s.actualArrivalAt&&idx===0;
    tr.innerHTML = `
      <td>${isWinner?`<span class="medal">${medals[0]}</span> `:''}${escapeHtml(p.name)}</td>
      <td>${fmt.toLocal(p.predictedAt)}</td>
      <td>${p.confidence}</td>
      <td class="muted">${fmt.toLocal(p.submittedAt)}</td>
      <td class="muted">${s.actualArrivalAt ? fmt.deltaLabel(p.predictedAt, s.actualArrivalAt) : ''}</td>`;
    if(isWinner) tr.classList.add('winner'); tbody.appendChild(tr);
  });
  $('#sortHint').textContent = s.actualArrivalAt ? 'Sorted by closest to actual' :
    (state.sortMode==='submittedAt' ? 'Sorting: latest submissions' : 'Sorting: by predicted time');
  if(s.actualArrivalAt && state.winner){ $('#winnerBadge').classList.remove('hidden'); $('#winnerText').textContent = `${state.winner.name} (${fmt.deltaLabel(state.winner.predictedAt, s.actualArrivalAt)})`; }
  else $('#winnerBadge').classList.add('hidden');
}

function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

/** =========================
 *  EVENTS
 *  ========================= */
$('#sortModeBtn').addEventListener('click', e=>{ e.preventDefault(); if(state.settings.actualArrivalAt) return; state.sortMode = state.sortMode==='submittedAt' ? 'predictedAt' : 'submittedAt'; renderBoard(); });

$('#predictForm').addEventListener('submit', async e=>{
  e.preventDefault();
  if(!CLIENT.canPost()){ alert('Easy tiger ‚Äî give it a few seconds before submitting again.'); return; }
  const s=state.settings; if(!s || !s.submissionsOpen){ alert('Predictions are closed.'); return; }
  const name=$('#name').value.trim(), phone=$('#phone').value.trim(), date=$('#predDate').value, time=$('#predTime').value, confidence=parseInt($('#confidence').value,10);
  if(!name||!phone||!date||!time||!confidence){ alert('Please fill everything.'); return; }
  const predictedIso = new Date(`${date}T${time}`).toISOString();
  if(new Date(predictedIso) < new Date(s.windowStart) || new Date(predictedIso) > new Date(s.windowEnd)){ alert('Pick a time within the 72-hour window.'); return; }

  $('#submitBtn').disabled=true; $('#submitBtn').textContent='Submitting‚Ä¶';
  try{
    await storage.savePrediction({name, phone, predictedAt:predictedIso, confidence, clientId: CLIENT.id, submittedAt: fmt.nowIso()});
    CLIENT.notePost(); fmt.confetti(); $('#predictForm').reset(); await refresh();
  }catch(err){ alert(err.message || 'Failed to submit.'); }
  finally{ $('#submitBtn').disabled=false; $('#submitBtn').textContent='Submit Prediction'; }
});

$('#shareBtn').addEventListener('click', async ()=>{
  const url=location.href, msg=`üë∂üíû Come guess Baby Carney‚Äôs arrival time!\n\nMake your pick here: ${url}`;
  if(navigator.share){ try{ await navigator.share({title:CONFIG.APP_NAME, text:msg, url}); }catch{} }
  else{ await navigator.clipboard.writeText(msg); alert('Invite copied!'); }
});

// Admin
$('#adminToggle').addEventListener('click', ()=>$('#adminPanel').classList.toggle('hidden'));
$('#unlockBtn').addEventListener('click', ()=>{ state.adminUnlocked = !!$('#adminPass').value; alert(state.adminUnlocked ? 'Admin unlocked' : 'Enter passphrase'); });
$('#windowStart').addEventListener('change', ()=>{ const start=new Date($('#windowStart').value); const end=new Date(start.getTime()+72*3600*1000); $('#windowEnd').value=fmt.localDateTimeInputValue(end.toISOString()); });
$('#saveWindowBtn').addEventListener('click', async ()=>{ if(!state.adminUnlocked) return alert('Unlock admin first.'); const pass=$('#adminPass').value, v=$('#windowStart').value; if(!v) return alert('Set a start datetime.');
  try{ await storage.setWindow(new Date(v).toISOString(), pass); await refresh(); alert('Window saved.'); }catch(e){ alert(e.message); } });
$('#toggleSubBtn').addEventListener('click', async ()=>{ if(!state.adminUnlocked) return alert('Unlock admin first.'); try{ await storage.toggleSubmissions($('#adminPass').value); await refresh(); }catch(e){ alert(e.message); } });
$('#setActualBtn').addEventListener('click', async ()=>{ if(!state.adminUnlocked) return alert('Unlock admin first.'); const v=$('#actualArrival').value; if(!v) return alert('Pick actual arrival datetime.');
  try{ await storage.setActualArrival(new Date(v).toISOString(), $('#adminPass').value); await refresh(); }catch(e){ alert(e.message); } });
$('#exportBtn').addEventListener('click', async ()=>{ if(!state.adminUnlocked) return alert('Unlock admin first.');
  try{ const {csv}=await storage.exportCSV($('#adminPass').value); const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='carney-arrival-predictions.csv'; a.click(); }catch(e){ alert(e.message); } });

/** =========================
 *  CLIENT throttle
 *  ========================= */
const CLIENT = (()=> {
  const keyId='cap_client_id', keyCD='cap_cooldown';
  let id = localStorage.getItem(keyId); if(!id){ id=crypto.randomUUID(); localStorage.setItem(keyId,id); }
  const cooldownMs=20*1000;
  return { id, canPost(){ const last=Number(localStorage.getItem(keyCD)||0); return Date.now()-last>cooldownMs; }, notePost(){ localStorage.setItem(keyCD,String(Date.now())); } };
})();

/** =========================
 *  LOAD / REFRESH with health diagnostics
 *  ========================= */
async function refresh(){
  try{
    const [settingsRes, listRes] = await Promise.all([storage.getSettings(), storage.listPredictions()]);
    state.settings=settingsRes.settings; state.predictions=listRes.predictions;
    $('#windowStart').value = fmt.localDateTimeInputValue(state.settings.windowStart);
    $('#windowEnd').value = fmt.localDateTimeInputValue(state.settings.windowEnd);
    $('#actualArrival').value = fmt.localDateTimeInputValue(state.settings.actualArrivalAt);
    renderStatus(); renderCountdown(); renderBoard();
  }catch(e){
    // If fetch failed (preflight/CORS/blocked), run a health GET and print a clear diag.
    const ping = await storage.health();
    let hint = `<div><strong>API URL</strong>: <code>${CONFIG.API_URL}</code></div>`;
    if(!ping.ok) hint += `<div><strong>GET health</strong>: ${ping.msg}</div>`;
    hint += `<ul style="margin:6px 0 0 16px">
      <li>Make sure Apps Script Web App is deployed as: <em>Execute as Me</em>, <em>Anyone with the link</em>.</li>
      <li>Ensure this file uses <code>text/plain</code> POST (already set) to avoid preflight.</li>
      <li>Try a private window; some extensions block <code>script.google.com</code>.</li>
    </ul>`;
    showDiag(`<div>Failed to load settings. Error: <code>${String(e)}</code></div>${hint}`);
    alert('Failed to load. Check API URL.\n' + e.message);
  }
}

refresh();
</script>
</body>
</html>
